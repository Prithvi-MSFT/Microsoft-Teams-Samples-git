extends layout.pug

block content
  script(src="/scripts/ssoDemo.js")
  script(type="text/javascript" src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js")
  script(src="/scripts/msal-auth.js")

  script.
   const url = new URL(window.location);
        const params = new URLSearchParams(url.search);

        if (params.get("inTeams")) {
           // Teams SSO Oauth Flow
            ssoAuth();
          } else {
            // MSAL Browser Auth
            const authService = new MsalAuthService("#{clientId}", "#{applicationIdUri}");

            $(document).ready(function msalAuth() {
              document.getElementById("browser-signin-container").hidden = false;
              document.getElementById("browser-signin-text").hidden = true;
              authService
                  .isCallback()
                  .then((isCallback) => {
                      if (!isCallback) {
                          authService
                              .getUser()
                              .then((user) => {
                                  // Signed in the user automatically; we're ready to go
                                  setUserSignedIn(true);
                                  getMyProfile(user.localAccountId);
                              })
                              .catch(() => {
                                  setUserSignedIn(false);
                                  // Failed to sign in the user automatically; show login screen
                                  console.log("Failed")
                              });
                      }
                  })
                  .catch((error) => {
                      // Encountered error during redirect login flow; show error screen
                      console.log(error);
                  });
            });

    function loginUser() {
        authService
            .login()
            .then((user) => {
                if (user) {
                    setUserSignedIn(true);
                    getMyProfile(user.localAccountId);
                } else {
                    setUserSignedIn(false);
                }
            })
            .catch((err) => {
                setUserSignedIn(false);
            });
    }

    function logout() {
        authService.logout();
    }

    function getMyProfile(userId) {
        setUserSignedIn(true);
        authService.getUserInfo(userId);
    }

    function setUserSignedIn(isUserSignedIn) {
      console.log(document.getElementById("browser-login"));
        document.getElementById("browser-login").hidden = isUserSignedIn;
    }
          }

  div(class="font-semibold font-title") Azure AD SSO Tab Demo  
  div(id="browser-signin-text") Try signing in from browser - 
    a(href="/ssodemo" target="_blank") Click here
  div(id="logs" style="overflow-x: hidden; overflow-y: scroll;")
  div(id="browser-signin-container" hidden="true")
    div(id="browser-login")
      h2() Please click on Login button to see your profile details!
      button(class="browser-button" onclick="loginUser()") Login
    div(id="divGraphProfile" style="display:none;")